# GPSSCAN - 測量写真リネームアプリケーション

[![Python](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

測量業務における写真管理を効率化する、GPS情報付き写真の自動リネームツールです。SIMファイルの測量点データと写真のGPS情報を照合し、測量規則に従った統一的なファイル名に自動変更します。

## 🌟 主な機能

### 📂 ファイル読み込み
- **SIMファイル対応**: A01/A02/D00形式に対応した測量データ読み込み
- **写真フォルダ読み込み**: GPS情報付きJPG写真の一括読み込み
- **EXIF情報抽出**: GPS座標、撮影日時の自動抽出

### 🗺️ 座標系対応
- **平面直角座標系**: 自動判定（1系〜19系）
- **任意座標系**: マイナス座標検出時の自動切り替え
- **GPS座標変換**: WGS84 → 平面直角座標系の自動変換
- **測量座標系**: X=北、Y=東の測量標準に対応

### 🎯 マッチング機能
- **ドラッグ&ドロップ**: 直感的な写真配置操作
- **2つのドラッグモード**:
  - モード1: 写真リストから地図へドラッグ
  - モード2: 地図上の写真マーカーをドラッグ
- **自動マッチング**: GPS座標に基づく最近傍測量点の自動検出
- **重複処理**: 同一測量点への複数写真配置時の自動調整

### 📷 写真分類・ファイル名生成
- **遠景/近景分類**: 視覚的な色分け表示（[遠]青色、[近]赤色）
- **自動ファイル名生成**: 測量規則に準拠した命名
- **重複回避**: 既存写真の通し番号化による衝突回避
- **座標復元**: 重複時の元座標自動復元

### 🎨 ユーザーインターフェース
- **対話型地図**: matplotlib による配置図表示
- **パン・ズーム操作**: 直感的な地図操作
- **リアルタイム更新**: ドラッグ操作の即座反映
- **操作ガイド**: 画面上の操作説明表示

### 💾 データ管理
- **バックアップ機能**: リネーム実行前の自動バックアップ
- **設定保存**: ユーザー設定の永続化
- **ログ出力**: 詳細なデバッグ情報

## 🚀 クイックスタート

### 必要環境
- Python 3.8以上
- Windows 10/11（推奨）

### インストール

1. **リポジトリのクローン**
```bash
git clone https://github.com/D1424-da/GPSSCAN.git
cd GPSSCAN
```

2. **仮想環境の作成**
```bash
python -m venv .venv
.venv\Scripts\activate  # Windows
```

3. **依存関係のインストール**
```bash
pip install -r requirements.txt
```

### 実行
```bash
python GPSSCAN.py
```

## 📋 必要なライブラリ

```txt
pillow>=9.0.0
pandas>=1.5.0
opencv-python>=4.6.0
numpy>=1.21.0
scikit-image>=0.19.0
pyproj>=3.4.0
matplotlib>=3.5.0
exifread>=3.0.0
japanize-matplotlib>=1.1.3
```

## 🎮 使用方法

### 基本ワークフロー

1. **SIMファイル読み込み**
   - メニュー「ファイル」→「SIMファイル読み込み」
   - A01/A02/D00形式のSIMファイルを選択

2. **写真フォルダ読み込み**
   - 「写真フォルダ選択」ボタンをクリック
   - GPS情報付きJPG写真が含まれるフォルダを選択

3. **ドラッグモード選択**
   - モード1: 写真リストから地図上の測量点へドラッグ
   - モード2: 地図上の写真マーカーをドラッグして再配置

4. **写真配置**
   - 写真を測量点にドラッグ&ドロップ
   - 遠景/近景選択ダイアログで分類

5. **リネーム実行**
   - 「リネーム実行」ボタンでファイル出力
   - バックアップ確認ダイアログ

### 地図操作

| 操作 | 機能 |
|------|------|
| 左クリック+ドラッグ | パン移動 |
| マウスホイール | ズーム拡大/縮小 |
| 右クリック | 写真選択 |
| 📍ボタン | 測量図の位置に戻る |

### ファイル名規則

#### 基本ルール
- **新規写真**: 基本形（例: `境界01-1.jpg`, `境界01-2.jpg`）
- **追加写真**: 既存写真を通し番号化、新規写真が基本形に
- **遠景**: `-1` サフィックス
- **近景**: `-2` サフィックス
- **3枚目以降**: `_3`, `_4`, `_5...` で連番

#### 重複処理例
```
1枚目配置: 境界01-2.jpg （近景）
2枚目配置: 境界01-2.jpg → 既存を 境界01_3.jpg に変更、新規が基本形に
```

## 🎯 対応座標系

### 平面直角座標系（自動判定）
- 1〜19系の自動判定
- GPS座標からの自動変換
- 測量標準（X=北、Y=東）対応

### 任意座標系
- マイナス座標検出時の自動切り替え
- 手動マッチング専用モード

## 🔧 高度な機能

### 自動マッチング
```
条件: GPS座標 + 指定距離範囲内の最近傍測量点
用途: 大量写真の一括処理
```

### 重複検出・座標復元
```
重複時: 既存写真のファイル名削除 + 元座標復元
新規時: 基本形ファイル名割り当て
```

### バックアップ機能
```
形式: backup_YYYYMMDD_HHMMSS フォルダ
実行: リネーム前の確認ダイアログ
```

## 🎨 視覚的特徴

### 配置図表示
- **測量点**: 青色○マーカー
- **地番境界**: 緑色線
- **写真位置**: 赤色×マーカー
- **ファイル名ラベル**: 遠景([遠]青色)、近景([近]赤色)

### ユーザーインターフェース
- **操作説明**: 画面上部の常時表示
- **ステータスバー**: 処理状況のリアルタイム表示
- **ダイアログ**: 拡張サイズで視認性向上

## 🐛 トラブルシューティング

### よくある問題

**Q: フォント警告が表示される**
```
A: japanize-matplotlib をインストール
pip install japanize-matplotlib
```

**Q: GPS座標変換が失敗する**
```
A: 座標系設定を確認
- 平面直角座標系の系番号が正しいか
- GPS変換有効化チェックボックスがオンか
```

**Q: 写真が地図に表示されない**
```
A: EXIF情報を確認
- GPS情報が写真に記録されているか
- 座標系が一致しているか
```

**Q: ドラッグ&ドロップが動作しない**
```
A: ドラッグモードを確認
- モード1: 写真リスト選択後にドラッグ
- モード2: 地図上の×マーカーをドラッグ
```

## 📊 開発情報

### アーキテクチャ
- **GUI**: tkinter + matplotlib (TkAgg backend)
- **座標変換**: pyproj
- **画像処理**: PIL + OpenCV
- **数値処理**: NumPy + pandas

### 主要コンポーネント
```
GPSScanApp: メインアプリケーションクラス
├── SIMファイル解析
├── GPS座標変換
├── ドラッグ&ドロップ処理
├── ファイル名生成
└── 地図表示・更新
```

## 🤝 コントリビューション

1. このリポジトリをフォーク
2. フィーチャーブランチを作成 (`git checkout -b feature/AmazingFeature`)
3. 変更をコミット (`git commit -m 'Add some AmazingFeature'`)
4. ブランチにプッシュ (`git push origin feature/AmazingFeature`)
5. プルリクエストを開く

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は [LICENSE](LICENSE) ファイルをご確認ください。

## 👤 作者

**D1424-da**

## 🙏 謝辞

- 測量業界の効率化に貢献できるツールの開発
- オープンソースコミュニティへの感謝

---

**⚡ 効率的な測量写真管理で、業務の生産性を向上させましょう！**